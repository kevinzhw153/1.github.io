<!doctype html>
<html>
<head>

	
	<title>首页 - Kevin 的博客 | 呃呃呃</title>
	<meta charset="utf-8">
	<!-- 以下为导入 4.x 版本配套的 CSS，为了兼容 3.x 请使用不加 -v4 的 CSS-->
	<link rel="stylesheet" type="text/css" href="./style/allcss-v4.css">
	<link rel="stylesheet" type="text/css" href="./style/divcss-v4.css">
	<link rel="stylesheet" type="text/css" href="./style/decocss-v4.css">
	<!-- font-awesome 图标库-->
	<link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
	<!-- -->
	<a href="https://count.58q.com/" target="_blank"><img src="https://count.58q.com/hit.php?id=yevmffp&nd=9&style=2" border="0" alt="网站计数器"></a>
<script async src="https://cse.google.com/cse.js?cx=017814980032632389432:xurynbeuhdq"></script>
<div class="gcse-search"></div>
	
	<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-173251435-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-173251435-1');
</script>

	<script src="./src.html"></script>

        <link rel="icon" type="image/ico" href="./img/!icon-bird.ico"/>	
<?php
/*
Template Name: 投稿模板
*/
if( isset($_POST['tougao_form']) && $_POST['tougao_form'] == 'send'){
    if ( isset($_COOKIE["tougao"]) && ( time() - $_COOKIE["tougao"] ) < 120 ){//这里的120是您限制多长时间内只能投稿一次
        wp_die('您投稿也太勤快了吧，先歇会儿！');
    }
    //表单变量初始化
    $name = isset( $_POST['tougao_authorname'] ) ? $_POST['tougao_authorname'] : '';
    $email = isset( $_POST['tougao_authoremail'] ) ? $_POST['tougao_authoremail'] : '';
    $blog = isset( $_POST['tougao_authorblog'] ) ? $_POST['tougao_authorblog'] : '';
    $title = isset( $_POST['tougao_title'] ) ? $_POST['tougao_title'] : '';
    $tags = isset( $_POST['tougao_tags'] ) ? $_POST['tougao_tags'] : '';
    $category = isset( $_POST['cat'] ) ? (int)$_POST['cat'] : 0;
    $content = isset( $_POST['tougao_content'] ) ? $_POST['tougao_content'] : '';
    //表单项数据验证
    if ( empty($name) || strlen($name) > 20 ){
        wp_die('昵称必须填写，且不得超过20个长度');
    }
    if ( empty($email) || strlen($email) > 60 || !preg_match("/^([a-z0-9\+_\-]+)(\.[a-z0-9\+_\-]+)*@([a-z0-9\-]+\.)+[a-z]{2,6}$/ix", $email)){
        wp_die('邮箱必须填写，且不得超过40个长度，必须符合 Email 格式');
    }
    if ( empty($title) || strlen($title) > 100 ){
        wp_die('文章标题必须填写，且不得超过100个长度');
    }
    if ( empty($content) || strlen($content) < 20){
        wp_die('内容必须填写，且不得少于20个长度');
    }
    $tougao = array(
        'post_title' => $title,                //标题
        'post_content' => $content,            //内容
        'post_status' => 'pending',            //待审
        'tags_input' => $tags,                //标签
        'post_category' => array($category)    //分类
    );
    //将文章插入数据库
    $status = wp_insert_post( $tougao );
    if ($status != 0){
    /*
        //将自定义域写入最新待审文章
        global $wpdb;
        $myposts = $wpdb->get_results("
            SELECT ID
            FROM $wpdb->posts
            WHERE post_status = 'pending'
            AND post_type = 'post'
            ORDER BY post_date DESC
        ");
        add_post_meta($myposts[0]->ID, 'cbs_postauthor', $name);    //插入投稿人昵称的自定义域
        if ( !empty($blog)) add_post_meta($myposts[0]->ID, 'cbs_posturl', $blog);    //插入投稿人网址的自定义域
    */
        setcookie("tougao", time(), time()+180);
        wp_die('投稿成功！','投稿成功！');
    } else {
        wp_die('投稿失败！','投稿失败！');
    }
<form id="tougaoform" method="post" action="<?php echo $_SERVER["REQUEST_URI"]; ?>">
        <p><input id="author" type="text" size="40" value="" name="tougao_authorname" /><label>昵称（*必填）</label></p>
        <p><input id="email" type="text" size="40" value="" name="tougao_authoremail" /><label>邮箱（*必填）</label></p>
        <p><input id="url" type="text" size="40" value="" name="tougao_authorblog" /><label>您的博客/文章来源</label></p>
        <p><input id="tougao_title" type="text" size="40" value="" name="tougao_title" /><label>文章标题（*必填）</label></p>
        <p><input id="tags" type="text" size="40" value="" name="tougao_tags" /><label>文章标签（多个标签请用英文逗号 , 分开）</label></p>
        <p><?php wp_dropdown_categories('show_option_none=请选择文章分类&show_count=1&hierarchical=1&hide_empty=0'); ?><label>文章分类（*必填）</label></p>
        <textarea rows="15" cols="55" id="tougao" name="tougao_content"></textarea>
        <p>
        <input type="hidden" value="send" name="tougao_form" />
        <input id="submit" type="submit" value="提交" />
        <input id="reset" type="reset" value="重填" />
        </p>
</form>
?>
	

	<script src="./script/showFooter.js"></script>
</body>
</html>
